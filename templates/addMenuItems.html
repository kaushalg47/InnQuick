{% extends 'base.html' %}

{% block title %}Food Menu Management{% endblock %}

{% block content %}
{% load dictionary_filters %}
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <h1 style="font-size: 28px; font-weight: bold; text-align: center; margin-bottom: 30px; color: #333;">Food Menu Management</h1>
        
        <div style="display: grid; grid-template-columns: 1fr; gap: 30px;">
            <!-- Add Menu Item Section -->
            <div style="background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 24px;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 8px;">Add New Menu Item</h2>
                <form id="addItemForm" method="POST" style="margin-bottom: 10px;">
                    {% csrf_token %}
                    <div style="margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label for="itemName" style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 5px;">Item Name</label>
                            <input type="text" id="itemName" name="name" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="itemPrice" style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 5px;">Price ($)</label>
                            <input type="text" id="itemPrice" name="price" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="itemDesc" style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 5px;">Description</label>
                            <textarea id="itemDesc" name="desc" required maxlength="300" rows="3"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="itemCategory" style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 5px;">Category</label>
                            <select id="itemCategory" name="category_id" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="" disabled selected>Select a category</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }} ({{ category.start_time|time:"g:i A" }} - {{ category.end_time|time:"g:i A" }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="submit" 
                        style="width: 100%; background-color: green; color: white; font-weight: 500; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 15px;">
                        Add Item
                    </button>
                </form>
                <p id="message" style="text-align: center; font-size: 14px; font-weight: 500; height: 20px; margin-top: 10px;"></p>
            </div>
            
            <!-- Category Modal -->
            <div id="categoryModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
                <div style="background-color: white; margin: 10% auto; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 600; color: #444; margin: 0;">Add New Category</h2>
                        <span id="closeModal" style="font-size: 24px; font-weight: bold; cursor: pointer; color: #666;">&times;</span>
                    </div>
                    <form id="addCategoryForm" method="POST">
                        {% csrf_token %}
                        <div style="margin-bottom: 15px;">
                            <label for="categoryName" style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 5px;">Category Name</label>
                            <input type="text" id="categoryName" name="category_name" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="startTime" style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 5px;">Start Time</label>
                            <input type="time" id="startTime" name="start_time" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="endTime" style="display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 5px;">End Time</label>
                            <input type="time" id="endTime" name="end_time" required
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        <button type="submit"
                            style="width: 100%; background-color: #2563eb; color: white; font-weight: 500; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 15px;">
                            Add Category
                        </button>
                    </form>
                </div>
            </div>

            <!-- Menu Items List Section -->
            <div style="background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: #444; margin: 0;">Current Menu Items by Category</h2>
                    <button id="openCategoryModal" style="background-color: #2563eb; color: white; font-size: 14px; font-weight: 500; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">
                        Add New Category
                    </button>
                </div>
                
                {% if categories %}
                    <div class="category-accordion">
                        {% for category in categories %}
                            <div class="category-section" style="margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                                <div class="category-header" onclick="toggleCategory('category-{{ category.id }}')" 
                                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background-color: #f9fafb; cursor: pointer;">
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: #374151;">
                                        {{ category.name }} 
                                        <span style="font-size: 14px; font-weight: 400; color: #6b7280;">
                                            ({{ category.start_time|time:"g:i A" }} - {{ category.end_time|time:"g:i A" }})
                                        </span>
                                    </h3>
                                    <span class="toggle-icon" id="icon-category-{{ category.id }}" style="font-size: 18px;">â–¼</span>
                                </div>
                                
                                <div class="category-content" id="category-{{ category.id }}" style="display: none;">
                                    {% with items=category_items|get_item:category %}
                                        {% if items %}
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #eee; background-color: #f9fafb;">
                                                        <th style="padding: 12px 15px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Name</th>
                                                        <th style="padding: 12px 15px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Description</th>
                                                        <th style="padding: 12px 15px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Price</th>
                                                        <th style="padding: 12px 15px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Status</th>
                                                        <th style="padding: 12px 15px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for item in items %}
                                                        <tr id="item-{{ item.id }}" style="border-bottom: 1px solid #eee;">
                                                            <td style="padding: 12px 15px; font-size: 14px; font-weight: 500; color: #333;">{{ item.name }}</td>
                                                            <td style="padding: 12px 15px; font-size: 14px; color: #6b7280;">{{ item.description }}</td>
                                                            <td style="padding: 12px 15px; font-size: 14px; color: #6b7280;">
                                                                {% if item.discount > 0 %}
                                                                    <span style="text-decoration: line-through;">${{ item.price }}</span>
                                                                    <span style="margin-left: 5px; font-weight: 500; color: #333;">
                                                                        ${{ item.discounted_price|default:item.price }}
                                                                    </span>
                                                                    <span style="margin-left: 5px; font-size: 12px; padding: 2px 6px; background-color: #f59e0b; color: white; border-radius: 20px;">
                                                                        {{ item.discount }}% OFF
                                                                    </span>
                                                                {% else %}
                                                                    ${{ item.price }}
                                                                {% endif %}
                                                            </td>
                                                            <td style="padding: 12px 15px; font-size: 14px;">
                                                                <label class="toggle-switch">
                                                                    <input type="checkbox" onclick="toggleActive({{ item.id }}, event)" class="toggle-input" 
                                                                        data-item-id="{{ item.id }}" {% if item.is_active %}checked{% endif %}>
                                                                    <span class="slider"></span>
                                                                    <span class="status-label">{{ item.is_active|yesno:"Active,Inactive" }}</span>
                                                                </label>
                                                            </td>
                                                            <td style="padding: 12px 15px; font-size: 14px;">
                                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                                    <button onclick="deleteItem({{ item.id }})"
                                                                        style="background-color: #ef4444; color: white; font-size: 12px; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;" class="delete-btn">
                                                                        Delete
                                                                    </button>
                                                                    
                                                                    
                                                                    
                                                                    <button onclick="openDiscountPopup({{ item.id }})"
                                                                        style="background-color: #f59e0b; color: white; font-size: 12px; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer;">
                                                                        %
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        {% else %}
                                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                                No items in this category.
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        No categories have been created yet.
                    </div>
                {% endif %}
                
                {% if not items %}
                    <div id="no-items" style="text-align: center; color: #6b7280; padding: 20px;">
                        No menu items added yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <style>
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        
        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
            background-color: #ccc;
            border-radius: 20px;
            transition: .3s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            border-radius: 50%;
            transition: .3s;
        }
        
        .toggle-input:checked + .slider {
            background-color: #22c55e;
        }
        
        .toggle-input:checked + .slider:before {
            transform: translateX(16px);
        }
        
        .status-label {
            margin-left: 8px;
            font-size: 12px;
            font-weight: 500;
        }
    </style>

    <script>
        // Keep track of open categories
        let openCategories = {};
        
        function toggleCategory(categoryId) {
            const content = document.getElementById(categoryId);
            const icon = document.getElementById('icon-' + categoryId);
            
            if (content.style.display === "none") {
                content.style.display = "block";
                icon.innerHTML = "â–²";
                // Save state
                openCategories[categoryId] = true;
            } else {
                content.style.display = "none";
                icon.innerHTML = "â–¼";
                // Remove from state
                delete openCategories[categoryId];
            }
            
            // Save to localStorage
            localStorage.setItem('openCategories', JSON.stringify(openCategories));
        }
        
        // Load open categories on page load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const saved = localStorage.getItem('openCategories');
                if (saved) {
                    openCategories = JSON.parse(saved);
                    
                    // Open saved categories
                    for (const categoryId in openCategories) {
                        const content = document.getElementById(categoryId);
                        const icon = document.getElementById('icon-' + categoryId);
                        
                        if (content && icon) {
                            content.style.display = "block";
                            icon.innerHTML = "â–²";
                        }
                    }
                }
            } catch (e) {
                console.error("Error restoring category state:", e);
                localStorage.removeItem('openCategories');
            }
        });
        
        document.getElementById("addItemForm").addEventListener("submit", async function(event) {
            event.preventDefault();
    
            const itemName = document.getElementById("itemName").value;
            const itemPrice = document.getElementById("itemPrice").value;
            const itemDesc = document.getElementById("itemDesc").value;
            const itemCategory = document.getElementById("itemCategory").value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch("/menu/add-item/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                    body: JSON.stringify({
                        name: itemName,
                        price: itemPrice,
                        description: itemDesc,
                        category: itemCategory,
                    }),
                });
    
                const data = await response.json();
                
                if (response.ok) {
                    // Show success message
                    const messageEl = document.getElementById("message");
                    messageEl.innerText = "Item added successfully!";
                    messageEl.style.color = "#10b981"; // Green success color
                    
                    // Clear the form
                    document.getElementById("itemName").value = "";
                    document.getElementById("itemPrice").value = "";
                    document.getElementById("itemDesc").value = "";
                    
                    // Reload page to show the new item
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    const messageEl = document.getElementById("message");
                    messageEl.innerText = "Error: " + data.error;
                    messageEl.style.color = "#ef4444"; // Red error color
                }
            } catch (error) {
                const messageEl = document.getElementById("message");
                messageEl.innerText = "An error occurred: " + error.message;
                messageEl.style.color = "#ef4444"; // Red error color
            }
        });

        
        // Category Modal Controls
        const categoryModal = document.getElementById("categoryModal");
        const openCategoryModalBtn = document.getElementById("openCategoryModal");
        const closeModalBtn = document.getElementById("closeModal");
        
        openCategoryModalBtn.addEventListener("click", function() {
            categoryModal.style.display = "block";
        });
        
        closeModalBtn.addEventListener("click", function() {
            categoryModal.style.display = "none";
        });
        
        // Close the modal if the user clicks outside of it
        window.addEventListener("click", function(event) {
            if (event.target === categoryModal) {
                categoryModal.style.display = "none";
            }
        });
        
        document.getElementById("addCategoryForm").addEventListener("submit", async function(event) {
            event.preventDefault();

            const categoryName = document.getElementById("categoryName").value;
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            try {
                const response = await fetch("/menu/create-category/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                    body: JSON.stringify({
                        name: categoryName,
                        start_time: startTime,
                        end_time: endTime,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    categoryModal.style.display = "none"; // Hide the modal
                    alert(`Category added successfully!`);
                    location.reload();
                } else {
                    alert("Failed to add category: " + data.error);
                }
            } catch (error) {
                console.error("Error adding category:", error);
                alert("An error occurred. See console for details.");
            }
        });

        // Updated toggleActive function for the sliding toggle button
        function toggleActive(itemId, event) {
            // Prevent any parent event handlers from firing
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const checkbox = event.target;
            const toggleSwitch = checkbox.closest('.toggle-switch'); // Get the parent wrapper
            const statusLabel = toggleSwitch.querySelector('.status-label');
            
            
            
            fetch(`/menu/toggle-active/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // Send an empty body
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`Server responded with ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    // Update checkbox state and label without page reload
                    checkbox.checked = data.active;
                    statusLabel.textContent = data.active ? "Active" : "Inactive";
                    
                } else {
                    alert('Failed to toggle status: ' + (data.error || 'Unknown error'));
                    // Revert checkbox state
                    checkbox.checked = !checkbox.checked;
                }
            })
            .catch(err => {
                console.error("Error toggling active status:", err);
                alert('Failed to toggle status: ' + err.message);
                // Revert checkbox state on error
                checkbox.checked = !checkbox.checked;
            })
            .finally(() => {
                // Re-enable the checkbox
                checkbox.disabled = false;
            });
        }

        function openDiscountPopup(itemId) {
            const discount = prompt("Enter discount percentage (e.g. 10):");
            if (discount !== null) {
                updateDiscount(itemId, parseFloat(discount));
            }
        }

        async function updateDiscount(itemId, discount) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            try {
                const res = await fetch(`/menu/update-discount/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({ discount }),
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Discount updated to ${data.discount}%`);
                    
                    // Get the price cell for this item
                    const row = document.getElementById(`item-${itemId}`);
                    if (row) {
                        const priceCell = row.cells[2]; // Assuming price is in the third column
                        
                        // Calculate the discounted price
                        const originalPrice = parseFloat(data.price);
                        const discountedPrice = (originalPrice * (100 - data.discount) / 100).toFixed(2);
                        
                        // Update the price display
                        if (data.discount > 0) {
                            priceCell.innerHTML = `
                                <span style="text-decoration: line-through;">$${originalPrice.toFixed(2)}</span>
                                <span style="margin-left: 5px; font-weight: 500; color: #333;">$${discountedPrice}</span>
                                <span style="margin-left: 5px; font-size: 12px; padding: 2px 6px; background-color: #f59e0b; color: white; border-radius: 20px;">
                                    ${data.discount}% OFF
                                </span>
                            `;
                        } else {
                            priceCell.innerHTML = `$${originalPrice.toFixed(2)}`;
                        }
                    }
                } else {
                    alert("Error updating discount: " + (data.error || "Unknown error"));
                }
            } catch (err) {
                alert("Error occurred: " + err.message);
            }
        }

        async function deleteItem(itemId) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (!confirm("Are you sure you want to delete this item?")) {
                return;
            }

            try {
                const response = await fetch(`/menu/delete-item/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();
                if (data.message) {
                    // Find the row and remove it
                    const row = document.getElementById(`item-${itemId}`);
                    if (row) {
                        // Find the parent table
                        const tbody = row.parentElement;
                        row.remove();
                        
                        // If no more rows, display "no items" message
                        if (tbody.children.length === 0) {
                            // Get the category content div
                            const categoryContent = tbody.closest('.category-content');
                            if (categoryContent) {
                                categoryContent.innerHTML = `
                                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                                        No items in this category.
                                    </div>
                                `;
                            }
                        }
                    }
                    
                    alert("Item deleted successfully");
                } else {
                    alert('Failed to delete the item: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert("An error occurred: " + error.message);
            }
        }
    </script>
{% endblock %}