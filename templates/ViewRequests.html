{% extends 'base.html' %}
{% block title %}Service Requests{% endblock %}

{% block content %}
<div class="service-dashboard">
  <header class="dashboard-header">
    <h1>Room Service Requests</h1>
    <div class="header-actions">
      <div class="auto-refresh">
        <span class="refresh-indicator"></span>
        <span class="refresh-text">Auto-refreshing</span>
      </div>
      <div class="notification-toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="soundToggle" checked>
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Sound Alerts</span>
      </div>
    </div>
  </header>

  <!-- Hidden audio element for notifications -->
  <audio id="notificationSound" preload="auto">
    <source src="https://assets.coderrocketfuel.com/pomodoro-times-up.mp3" type="audio/mp3">
  </audio>

  <div class="requests-grid" id="requests-container">
    {% for request in requests %}
    <div class="request-card" id="request-{{ request.id }}" data-request-id="{{ request.id }}">
      <div class="request-header">
        <h3 class="room-number">Room {{ request.room.number }}</h3>
        <span class="request-time">{{ request.created_at }}</span>
      </div>
      
      <div class="request-details">
        <div class="service-type">
          <span class="service-icon">
            {% if request.service_type == 'cleaning' %}
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5Z"></path><path d="m3 5 5 5"></path><path d="m3 19 5-5"></path><path d="m21 5-5 5"></path><path d="m21 19-5-5"></path><path d="M9 5h6"></path><path d="M9 19h6"></path><path d="M5 9v6"></path><path d="M19 9v6"></path></svg>
            {% elif request.service_type == 'maintenance' %}
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
            {% elif request.service_type == 'laundry' %}
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22V4c0-.5.2-1 .6-1.4C5 2.2 5.5 2 6 2h12c.5 0 1 .2 1.4.6.4.4.6.9.6 1.4v18H4z"></path><path d="M3 4h18"></path><path d="M3 8h18"></path><path d="M8 12h8"></path><path d="M8 16h8"></path><circle cx="12" cy="16" r="1"></circle></svg>
            {% else %}
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4"></path><path d="M12 16h.01"></path></svg>
            {% endif %}
          </span>
          <span class="service-name">{{ request.service_type|capfirst }}</span>
        </div>
      </div>
      
      <div class="request-actions">
        <button class="btn-complete" onclick="confirmAction({{ request.id }})">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          <span>Complete Service</span>
        </button>
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <div class="empty-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l.3-.3c2-2 3-3 3-4.4 0-1.2-1-2.3-2.3-2.3-.5 0-1 .1-1.3.4L12 12l-.7-.8c-.3-.3-.8-.4-1.3-.4h-.2c-1.2 0-2.2 1-2.2 2.3 0 1.4 1 2.4 3 4.4l.4.3z"></path><path d="M16.5 12.4V5.3c0-1-.4-1.9-1.2-2.6s-1.7-1-2.7-.9c-2 .2-3.6 1.9-3.6 3.9v1.5L12 9l3-1.5"></path><path d="M22 12c0 5.5-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2s10 4.5 10 10z"></path></svg>
      </div>
      <p>All caught up! No pending service requests.</p>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Complete Service Request</h2>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <p>Has this service request been completed?</p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel">Cancel</button>
      <button class="btn-confirm">Confirm Completion</button>
    </div>
  </div>
</div>

<style>
  .service-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.5rem;
  }
  
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .dashboard-header h1 {
    color: #2d3748;
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0;
  }
  
  .header-actions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }
  
  .auto-refresh {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    color: #718096;
  }
  
  .refresh-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #48bb78;
    border-radius: 50%;
    margin-right: 0.5rem;
    animation: pulse 2s infinite;
  }
  
  .notification-toggle {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    color: #718096;
  }
  
  .toggle-label {
    margin-left: 0.5rem;
  }
  
  /* Toggle switch styling */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 36px;
    height: 20px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5e0;
    transition: .4s;
    border-radius: 34px;
  }
  
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .toggle-slider {
    background-color: #48bb78;
  }
  
  input:checked + .toggle-slider:before {
    transform: translateX(16px);
  }
  
  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.4;
    }
    100% {
      opacity: 1;
    }
  }
  
  .requests-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }
  
  .request-card {
    background-color: #ffffff;
    border-radius: 0.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .request-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
  }
  
  /* New request highlight */
  .request-card.new-request {
    animation: highlight 2s ease-in-out;
    border: 2px solid #4299e1;
  }
  
  @keyframes highlight {
    0% {
      box-shadow: 0 0 0 rgba(66, 153, 225, 0);
    }
    50% {
      box-shadow: 0 0 15px rgba(66, 153, 225, 0.6);
    }
    100% {
      box-shadow: 0 0 0 rgba(66, 153, 225, 0);
    }
  }
  
  .request-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: #f7fafc;
    border-bottom: 1px solid #edf2f7;
  }
  
  .room-number {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
  }
  
  .request-time {
    font-size: 0.75rem;
    color: #718096;
  }
  
  .request-details {
    padding: 1.25rem;
  }
  
  .service-type {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .service-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #ebf8ff;
    color: #3182ce;
    margin-right: 0.75rem;
  }
  
  .service-name {
    font-weight: 500;
    color: #4a5568;
    font-size: 1.1rem;
  }
  
  .request-actions {
    padding: 1rem;
    border-top: 1px solid #edf2f7;
  }
  
  .btn-complete {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 0.75rem 1rem;
    background-color: #2ecc71;
    color: white;
    border: none;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .btn-complete:hover {
    background-color: #2f855a;
  }
  
  .btn-complete svg {
    margin-right: 0.5rem;
  }
  
  .empty-state {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    background-color: #f7fafc;
    border-radius: 0.5rem;
    border: 1px dashed #cbd5e0;
  }
  
  .empty-icon {
    color: #a0aec0;
    margin-bottom: 1rem;
  }
  
  .empty-state p {
    color: #4a5568;
    font-size: 1.125rem;
    text-align: center;
    margin: 0;
  }
  
  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background-color: #fff;
    border-radius: 0.5rem;
    max-width: 450px;
    width: 100%;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    animation: modalFadeIn 0.3s;
  }
  
  @keyframes modalFadeIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .modal-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
  }
  
  .close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #a0aec0;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }
  
  .modal-body {
    padding: 1.5rem;
  }
  
  .modal-body p {
    margin: 0;
    color: #4a5568;
    font-size: 1rem;
  }
  
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    padding: 1.25rem 1.5rem;
    border-top: 1px solid #e2e8f0;
    gap: 1rem;
  }
  
  .btn-cancel {
    padding: 0.625rem 1.25rem;
    background-color: #edf2f7;
    color: #4a5568;
    border: none;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .btn-cancel:hover {
    background-color: #e2e8f0;
  }
  
  .btn-confirm {
    padding: 0.625rem 1.25rem;
    background-color: #38a169;
    color: white;
    border: none;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .btn-confirm:hover {
    background-color: #2f855a;
  }
  
  /* Toast notification styles */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 4px;
    color: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .toast-success {
    background-color: #38a169;
  }
  
  .toast-error {
    background-color: #e53e3e;
  }
  
  .toast-info {
    background-color: #4299e1;
  }
  
  /* Responsive adjustments */
  @media screen and (max-width: 768px) {
    .requests-grid {
      grid-template-columns: 1fr;
    }
    
    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .header-actions {
      width: 100%;
      justify-content: space-between;
    }
  }
</style>

<script>
  // Store current request IDs when page loads
  let currentRequestIds = [];
  let soundEnabled = true;
  const notificationSound = document.getElementById('notificationSound');
  const soundToggle = document.getElementById('soundToggle');
  
  // Function to initialize the page
  function initializePage() {
    // Get all current request IDs
    const requestCards = document.querySelectorAll('.request-card');
    currentRequestIds = Array.from(requestCards).map(card => 
      card.getAttribute('data-request-id')
    );
    
    // Store request IDs in localStorage
    localStorage.setItem('requestIds', JSON.stringify(currentRequestIds));
    
    // Initialize sound toggle from localStorage or default to true
    const savedSoundSetting = localStorage.getItem('soundEnabled');
    if (savedSoundSetting !== null) {
      soundEnabled = savedSoundSetting === 'true';
      soundToggle.checked = soundEnabled;
    }
    
    // Add event listener for sound toggle
    soundToggle.addEventListener('change', function() {
      soundEnabled = this.checked;
      localStorage.setItem('soundEnabled', soundEnabled);
    });
  }
  
  // Run on page load
  document.addEventListener('DOMContentLoaded', initializePage);
  
  // Function to check for new requests when page loads
  window.addEventListener('load', function() {
    // Get the previously stored request IDs
    const previousRequestIds = JSON.parse(localStorage.getItem('requestIds')) || [];
    
    // Get current request IDs
    const currentElements = document.querySelectorAll('.request-card');
    const currentIds = Array.from(currentElements).map(el => 
      el.getAttribute('data-request-id')
    );
    
    // Find new requests (IDs that exist now but weren't in the previous set)
    const newRequestIds = currentIds.filter(id => !previousRequestIds.includes(id));
    
    // If there are new requests and sound is enabled, play notification
    if (newRequestIds.length > 0 && soundEnabled) {
      // Play notification sound
      notificationSound.play().catch(e => console.log('Sound play failed:', e));
      
      // Highlight new requests
      newRequestIds.forEach(id => {
        const element = document.querySelector(`.request-card[data-request-id="${id}"]`);
        if (element) {
          element.classList.add('new-request');
          // Remove highlight class after animation completes
          setTimeout(() => {
            element.classList.remove('new-request');
          }, 5000);
        }
      });
      
      // Show notification about new requests
      showToast(`${newRequestIds.length} new service request${newRequestIds.length > 1 ? 's' : ''} received`, false, 'info');
    }
    
    // Update localStorage with current IDs for next page load
    localStorage.setItem('requestIds', JSON.stringify(currentIds));
  });
  
  // Auto refresh every 30 seconds
  setTimeout(() => {
    window.location.reload();
  }, 30000);
  
  // Variables for keeping track of the request being processed
  let currentRequestId = null;
  const modal = document.getElementById('confirmationModal');
  
  // Function to show the confirmation modal
  function confirmAction(requestId) {
    currentRequestId = requestId;
    modal.style.display = 'flex';
    
    // Add event listener to the close button
    document.querySelector('.close-modal').addEventListener('click', closeModal);
    
    // Add event listener to the cancel button
    document.querySelector('.btn-cancel').addEventListener('click', closeModal);
    
    // Add event listener to the confirm button
    document.querySelector('.btn-confirm').addEventListener('click', () => {
      markAsDone(currentRequestId);
      closeModal();
    });
    
    // Close modal if clicked outside
    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  }
  
  // Function to close the modal
  function closeModal() {
    modal.style.display = 'none';
    currentRequestId = null;
  }
  
  // Function to mark a request as done
  function markAsDone(requestId) {
    const requestCard = document.getElementById(`request-${requestId}`);
    
    // Add visual feedback before sending request
    requestCard.style.opacity = '0.7';
    requestCard.style.pointerEvents = 'none';
    
    fetch(`${requestId}/mark-serviced`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        // Add a fade-out animation
        requestCard.style.transform = 'scale(0.95)';
        requestCard.style.opacity = '0';
        
        // Remove the card after animation completes
        setTimeout(() => {
          requestCard.remove();
          
          // Show toast notification
          showToast(data.message);
          
          // Check if we need to show empty state
          const container = document.getElementById('requests-container');
          if (!container.querySelector('.request-card')) {
            const emptyState = createEmptyState();
            container.appendChild(emptyState);
          }
          
          // Update stored request IDs
          updateStoredRequestIds();
        }, 300);
      } else if (data.error) {
        // Restore card to normal if there's an error
        requestCard.style.opacity = '1';
        requestCard.style.pointerEvents = 'auto';
        showToast(data.error, true);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      // Restore card to normal if there's an error
      requestCard.style.opacity = '1';
      requestCard.style.pointerEvents = 'auto';
      showToast('An error occurred. Please try again.', true);
    });
  }
  
  // Function to update stored request IDs after completion
  function updateStoredRequestIds() {
    const requestCards = document.querySelectorAll('.request-card');
    const currentIds = Array.from(requestCards).map(card => 
      card.getAttribute('data-request-id')
    );
    localStorage.setItem('requestIds', JSON.stringify(currentIds));
  }
  
  // Function to create empty state element
  function createEmptyState() {
    const emptyState = document.createElement('div');
    emptyState.className = 'empty-state';
    emptyState.innerHTML = `
      <div class="empty-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l.3-.3c2-2 3-3 3-4.4 0-1.2-1-2.3-2.3-2.3-.5 0-1 .1-1.3.4L12 12l-.7-.8c-.3-.3-.8-.4-1.3-.4h-.2c-1.2 0-2.2 1-2.2 2.3 0 1.4 1 2.4 3 4.4l.4.3z"></path><path d="M16.5 12.4V5.3c0-1-.4-1.9-1.2-2.6s-1.7-1-2.7-.9c-2 .2-3.6 1.9-3.6 3.9v1.5L12 9l3-1.5"></path><path d="M22 12c0 5.5-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2s10 4.5 10 10z"></path></svg>
      </div>
      <p>All caught up! No pending service requests.</p>
    `;
    return emptyState;
  }
  
  // Function to show toast notification
  function showToast(message, isError = false, type = 'success') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast ${isError ? 'toast-error' : type === 'info' ? 'toast-info' : 'toast-success'}`;
    toast.textContent = message;
    
    // Add toast to the DOM
    document.body.appendChild(toast);
    
    // Add styles for the toast
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.right = '20px';
    toast.style.padding = '12px 20px';
    toast.style.borderRadius = '4px';
    toast.style.color = 'white';
    toast.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
    toast.style.zIndex = '1000';
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(20px)';
    toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    
    // Trigger animation
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      
      // Remove from DOM after fade out
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }
</script>
{% endblock %}